# Alternative Splicing Pipeline (Nextflow)

Nextflow DSL2 scaffold for alternative splicing analyses on genome-aligned paired-end RNA-seq BAMs. The workflow is organized for junction discovery, event-level calls, isoform assembly/quantification, and reporting.

## Layout
- `main.nf` – pipeline entry with stubbed processes for junction extraction (regtools), event callers (rMATS/LeafCutter), assembly/quantification (StringTie/gffcompare/Salmon), and plotting hooks.
- `nextflow.config` – defaults for params, executors, and log/output locations; extend with per-environment profiles under `conf/`.
- `metadata/` – sample sheet lives here (see `metadata/samples.tsv` template).
- `metadata/goi.tsv` – gene-of-interest list for sashimi plots (regions auto-resolved from GTF when missing).
- `resources/` – reference genome/annotation (FASTA/GTF) and any tool-specific indexes.
- `modules/local/`, `bin/` – place custom Nextflow modules and helper scripts.
- `results/`, `logs/` – pipeline outputs; `work/` is created by Nextflow at runtime.

## Metadata (uses your provided table)
`metadata/samples.tsv` is the real dataset you supplied (columns: `Run`, `Experiment`, `BiologicalState`, `Stranded`, `ReadLength`, `Use`, ...). The pipeline auto-derives:
- `sample_id` ← `Run`
- `condition` ← `BiologicalState`
- `dataset` ← `SourceAbbr` (fallback: `Source`), kept in outputs to separate ANU/IDB/MSU/SPBU material
- `strandedness` ← `Stranded` (expects `RF` or `FR`; falls back to `params.strandedness`)
- `readlen` ← `ReadLength` (used to pick/build STAR indices)
- only rows with `Use=TRUE` / `YES` / `1` are processed

To limit the run to a subset (e.g., 2 conditions × 3 replicates), set `Use=TRUE` for those rows and `FALSE` for the rest.
FASTQ paths are loaded from `metadata/samplesheet.csv`, which is generated by `nf-core/fetchngs` (see below).

## Fetch FASTQs (once)
You can create `ids.csv` from the `Experiment` values from `metadata/samples.tsv` and download FASTQs with:

```bash
cut -f14 alternative_splicing/metadata/samples.tsv | tail -n +2 > ids.csv
export SRA_DATA=/home/lab/kim/hd/rnaseq/reads_pe/raw/
nextflow run nf-core/fetchngs --input ./ids.csv --outdir ${SRA_DATA}
```

Point `params.samplesheet` in `nextflow.config` to the resulting `${SRA_DATA}/samplesheet/samplesheet.csv`. It should contain columns like these:
```
sample	fastq_1	fastq_2	run_accession	experiment_accession	sample_accession ...
```


## Running
Update `gtf` and `fasta` (reference) in `nextflow.config` or via `-params-file` and launch:

```bash
cd alternative_splicing
nextflow run main.nf -profile local \
  --samples metadata/samples.tsv \
  --gtf resources/reference.gtf \
  --fasta resources/reference.fasta \
  --outdir results
```

Optional: add a `metadata/goi.tsv` with `gene_id`, optional `region` (chr:start-end), and `description` (used for plot labels) to trigger ggsashimi plots. If `region` is blank and `--gtf` is provided, regions are derived from gene entries in the GTF/GFF:
```
gene_id	description	region
VCP	VCP/p97	
```

Outputs land under `results/` and `logs/`. Swap `-profile` once you add HPC/cloud settings under `conf/`.

## What the pipeline does now (StringTie.sh parity)
- Downloads SRA runs (from the `Run` column) with `fasterq-dump` → gzip
- QC/trim with `fastp`
- Builds STAR indices per read length automatically under `resources/star_index/`
- Aligns with STAR → sorted BAM + index
- Junction discovery: regtools junctions extract per sample → merged union + sample and dataset-level count tables under `results/junctions/`
- Assembles with StringTie
- Downstream placeholders: gffcompare merge/compare, LeafCutter/rMATS prep, transcriptome build, Salmon quant
- Visualization: optional ggsashimi plots per GOI region

Regtools outputs (in `results/junctions/`):
- `*.junctions.bed` per sample (regtools extract)
- `junctions_manifest.tsv` with sample/condition/dataset mapping
- `junction_counts_sample.tsv` (long table with counts per junction/sample/condition/dataset)
- `junction_counts_matrix.tsv` (junction × sample wide matrix)
- `junction_counts_dataset.tsv` (junction × dataset long table, summed across samples)
- `junctions_union.bed` (unique junctions with summed counts)
- If `--goi` is provided, GOI-filtered junction summaries are also written: `junction_counts_sample_goi.tsv`, `junction_counts_matrix_goi.tsv`, `junction_counts_dataset_goi.tsv`, and `junctions_union_goi.bed` (filtered to GOI `region_extended` windows).

GOI resolution and manifests:
- `goi.resolved.tsv` (under `results/sashimi/`) now includes `gene_id`, `region` (gene span), `region_extended` (gene span padded to midpoint to nearest neighbor, at least ±goi_pad; default ±1000 bp), and `label`.
- `bam_manifest.tsv` (under `results/sashimi/`) lists sample → BAM + condition/dataset for sashimi plotting.

## Requirements
- SRA Toolkit (`prefetch`/`fasterq-dump`), `fastp`, `STAR`, `samtools`, `stringtie`
- `regtools` for junction extraction (see `envs/regtools.yml` for a ready conda env), `ggsashimi` for sashimi plots
- `pyranges` (via conda) for resolving GOI regions from GTF/GFF
- Reference FASTA/GTF set via `--fasta` / `--gtf`
